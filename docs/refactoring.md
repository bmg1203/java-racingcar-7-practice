# 리팩토링
> 리팩토링은 작은 개선 사항부터 시작
> - 불필요한 import 제거, 네이밍 변경 등 작은 부분부터 시작한다
> - 리팩토링은 버그를 고치는 행동이 아니다, 이전과 동일하게 동작하면서 진행하는 것이 리팩토링이다
> - 리팩토링을 후 성공 테스트 코드가 실패하면 리팩토링을 잘못 하고 있는 것

## 나의 3-Tier Layered Architecture
- 기본 레이어: Presentation Layer(view, client) -> Business Layer(service) -> Domain Layer
  - Presentation 계층: 사용자와의 협력(화면), 서비스 요청과 응답 처리, `InputView`, `OutputView`, `RacingCarController`
  - Business 계층: 비즈니스의 흐름을 보여줌(어떤 흐름으로 서비스의 핵심이 제공되는지),`RacingCarService`
  - Domain 계층: 현재 서비스를 지탱하는 중요한 개념(비즈니스 로직)들이 존재함, `Car`, `Racing`
- 레이어를 건너 뛸 수 없음, 즉 한 방향으로만 한 계층 씩 의존 가능
- 왜 도입했나?
  - UI(입력 화면)와 핵심을 분리하기 편함
  - 각 계층의 역할이 명확함
  - 핵심(domain)에 집중할 수 있음

## 개념과 격벽
- 1급 개념은 서비스를 지탱하는 핵심 개념을 말함
- 2급 개념은 1급 개념에 의존하는 개념을 말함
- 3급 개념은 2급 개념을 통해 서비스를 이용하는 사용자들과 상호작용을 직접 이루는 개념을 말함
- 같은 격벽 내부에 존재하는 개념들은 서로 의존할 수 있음
- 격벽을 넘을 수 있게, 즉 계층을 뛰어 넘을 수 있게 설정한 개념들만 다른 격벽의 개념에 접근 가능 

## 리팩토링 필요 판단 근거
- 작성한 코드에 대한 근거가 존재하는가?
  - 왜 생성자 대신 정적 팩토리 메서드를 썼는지 근거가 있나?
  - 왜 `enum`로 관리하지 않고 메서드 내 상수로 쓰고 있나?
  - 메서드 이름만으로 어떤 기능을 하는지 충분하나?
- 문자열과 숫자는 무조건 상수로 만들어야하나?
  - 상수일 필요가 있나?
  - 상수로 만드는 이유는? -> 상수로 만들지 않아도 어떤 역할을 하는지 드러나나?
  - 한 곳에서만 쓰인 다면 굳이 상수로 만들 필요가 있나?
- 도메인 로직이 외부로 유출되고 있는가?
  - 테스트 코드, 도메인 계층 외부로 도메인 로직이 유출되고 있는지 확인한다
  - 위 계층이 도메인을 몰라야 한다
- 변경을 예상하지 않는다. 그저 변경이 발생하면 수용할 수 있는 유연함을 담는다
- 사용자 입력을 받을 때 `null`은 언제 발생할까?
  - 사용자가 잘못된 형식의 데이터를 입력하는 경우 발생 가능 -> 입력에서는 공백만을 잘못된 형식으로 보고 예외를 던진다
  - 요청을 전달하면서 필요한 데이터를 누락하는 경우 발생 가능 -> final 로 누락되지 않게 만든다
  - DTO 사용 시 데이터를 누락하는 경우 발생 가능 -> record 사용해 누락을 막는다
  - Scanner의 nextLine() 사용하는 Console 에서 null을 반환하는 상황은 개발자의 실수로 만들어짐, 그로 인해 `NoSuchElementException`, `IllegalStateException` 발생
  - ApplicationTest.run() 메서드는 args를 개행문자 `\n`를 String.join()으로 연결, 즉 `"args[0]\nargs[1]\n"` 처리
  - 원인 불명의 null이 발생해 Objects.requireNonNull()에서 NPE가 터진 경우 `IllegalArgumentException`가 아님, 사용자의 잘못이 아닌 개발자의 실수
  - `IllegalArgumentException`를 던지면 디버깅이 어려움 -> 현재 프로젝트에서 NPE가 발생하면 데이터 누락같은 실수일 확률이 높음
- 역할, 책임, 협력
  - 이름을 구분하는 것은 Presentation 계층의 책임, 서비스는 입력의 형태(이름을 쉼표로 구분해 입력하는)를 알 필요가 없음

## 리팩토링 절차
- 리팩토링은 작은 단위에서 시작한다
  - 작은 단위의 리팩토링은 30분을 넘지 않는다 -> 구현 완료가 가장 중요한 목표
  - 작은 단위의 리팩토링 중 여러 부분을 신경쓰기 시작하면 메서드 하나에 하루를 잡아먹음(실제로 그럼)
- 작은 단위의 리팩토링: 이해를 위한, 쓰레기 줍기, 준비를 위한
  - 쓰레기 줍기: 불필요한 import 제거, 컨벤션 준수
  - 이해를 위한: 변수/메서드/클래스 이름에 역할/행동이 잘 드러나나?
  - 

1. 변수(+ 상수), 메서드, 클래스 이름이 적절한가? 예외 메시지가 적절한가?
   - 예외 메시지에 부정적인 단어 포함 X
   - 
2. 메서드가 어떤 행동을 하고 있는지 한눈에 유추 가능한가?
3. 반복되는 코드가 존재하나?
4. 적절한 책임을 갖고 있나? 너무 많은 책임을 갖고 있나?
    - 개념에서 파생되는 개념이 많나?
    - 개념과 어울리지 않는 행동을 하고 있나?
    - 개념을 상태와 행동으로 착각했나?
    - 상태와 행동을 개념으로 착각했나?
